name: Security Scanning & Code Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly scan

jobs:
  npm-audit:
    name: NPM Audit & Dependency Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Backend Dependencies
      run: cd src/backend && npm install
      continue-on-error: true

    - name: Install Frontend Dependencies
      run: cd src/frontend && npm install
      continue-on-error: true

    - name: Run npm audit (Backend)
      run: cd src/backend && npm audit --audit-level=moderate || true
      continue-on-error: true

    - name: Run npm audit (Frontend)
      run: cd src/frontend && npm audit --audit-level=moderate || true
      continue-on-error: true

    - name: Check for vulnerabilities (Backend)
      run: cd src/backend && npm list --depth=0 2>&1 || true
      continue-on-error: true

    - name: Check for vulnerabilities (Frontend)
      run: cd src/frontend && npm list --depth=0 2>&1 || true
      continue-on-error: true

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        cd src/backend && npm install
        cd ../frontend && npm install
      continue-on-error: true

    - name: Run ESLint (Backend)
      run: cd src/backend && npm install eslint 2>/dev/null && npx eslint . --format=json > eslint-report.json 2>&1 || true
      continue-on-error: true

    - name: Run ESLint (Frontend)
      run: cd src/frontend && npm install eslint 2>/dev/null && npx eslint src --format=json > eslint-report.json 2>&1 || true
      continue-on-error: true

    - name: Upload analysis reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-analysis-reports
        path: |
          src/backend/eslint-report.json
          src/frontend/eslint-report.json
